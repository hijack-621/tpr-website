<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5C upload&Search</title>
</head>
<link rel="stylesheet" href="../../../../TPRindex/css/style.css" type="text/css" media="screen" />
<link rel='stylesheet' href='../../../../layui/css/layui.css'>
<link rel='stylesheet' href='../../../../layui/css/public.css'>
<script type='text/javascript' src='../../../../js/jquery-3.2.1.js' ></script>
<script type='text/javascript' src='../../../../layui/layui.js' ></script>
<script type='text/javascript' src='../../../../js/date.format.js' ></script>
<link rel="shortcut icon" href="../../../../images/logo.ico" type="image/x-icon">
<style>
body {
	background-image: url(../../../../images/bg.png)!important;
}
a:link {
	color: #FFF;
	text-decoration: none;
}
a:visited {
	color: #FFF;
	text-decoration: none;
}
a:hover {
	color: #000;
	text-decoration: underline;
}
a:active {
	text-decoration: none;
}
.layui-table thead tr th{
    color:rgb(47, 27, 66);
    font-weight: bold;
    text-align: center;
}
#demoList td {
    color:rgb(47, 27, 66);
    font-weight: bold;
    text-align: center;  
}


.hm{
	height:20px;
	display: inline-block;
	padding: 0px 5px 2px;
	color: #fff;
	border: none;
	font-family: "Adobe 婵犲痉鏉匡拷婵炴挸婀辩槐鐐烘晸缁插d R";
	font-size: 16px;
	text-decoration: none;
	background-color: #CC6633;
	position: relative;
	cursor: poiner;
}
.sub{
	height:20px;
	display: inline-block;
	padding: 0px 5px 2px;
	color: #fff;
	border: none;
	font-family: "Adobe 婵犲痉鏉匡拷婵炴挸婀辩槐鐐烘晸缁插d R";
	font-size: 16px;
	text-decoration: none;
	background-color: #0077FF;
	position: relative;
	cursor: poiner;
}
.a1{
	margin:10px 0px 20px 0px;
	}
.a2{
	
	margin:0 auto;
	overflow:auto;
	height:300px;
	width:80%;
	text-align:center;
	}

.YS0 {color: black;
	font-weight: bold;
	font-size: 24px;
}
.a3{
	color:#FFF;
	}
	
	#num_pot td{
		border-bottom:none;
	}
	#num_pot div{
	float:left;
	display:none;
	}

	#label_div{
	margin:0 30px;
	}
	#week_td{
	color:#FFFFFF;
	}
		#a12 a{
	 text-decoration:none;
	color:#FFFFFF;
	}
	#a12 table{
	background-color:#9dddcd;
	}
	#a12 td{
	color:#FFFFFF;
	}
	#a12{
	display:none;
	overflow:auto;
	height:320px;
	}

#b_st{
		display:none;
}
table tr td{
			border:none;
		}

</style>
<script type="text/html" id="toolbarDemo">
 
</script>
<body>
    <div id="header-wrap">
        <header>
            <hgroup>
                <h1><a href="../../../../index.php">Comppal</a></h1>
                <h3>Just Another Styleshout Template</h3>
            </hgroup>
            <nav style="margin-top: 40px;">
                <div >
                    <ul id="dh">
                        <li><a href="../../../../index.php">Home</a></li>
                        <li><a href="../../../../total_system_sop.html">SOP</a></li>
                        <li><a href="#portfolio">Our Works</a></li>
                        <li><a href="#about-us">About Us</a></li>
                        <li><a href="#contact">Contact Us</a></li>
                    </ul>
                </div>
            </nav>
    
        </header>
    
    </div>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 130px;">
        <legend></legend>
      </fieldset> 
       
      <div class="layui-upload">
        <button type="button" class="layui-btn layui-btn-normal" style="margin-left: 10px;" id="testList">Select-File</button> 
        
        <div class="layui-upload-list">
          <table class="layui-table" lay-even lay-shin='nob'>
            <thead>
              <tr><th>文件名[filename]</th>
              <th>大小[size]</th>
              <th>状态[status]</th>
              <th>操作[operation]</th>
            </tr></thead>
            <tbody id="demoList"></tbody>
          </table>
        </div>
        <button type="button" class="layui-btn layui-btn-normal" style="margin-left: 10px;" id="testListAction">Upload</button>
      </div> 
      <fieldset class="table-search-fieldset" style="width: 1000px;">
        <legend></legend>
        <div style="margin: 10px 10px 10px 10px">
            <form class="layui-form layui-form-pane" action="">
                <div class="layui-form-item">
                  <div class="layui-inline">
                    <label class="layui-form-label">TPR</label>
                    <div class="layui-input-inline">
                      <select class='' name='tpr' lay-filter='select'>
                        <option  value='bk'>choose before uploading or searching</option>
                        <option  value='CGS'>CGS</option>
                        <option  value='CEP'>CEP</option>
                        <option  value='CEB'>CEB</option>
                        <option  value='RLC-SH'>RLC-SH</option>
                        <option  value='IGS'>IGS</option>
                        <option  value='TSI'>TSI</option>
                        <option  value='CTDI'>CTDI</option>
                        <option  value='ICC-RLG'>ICC-RLG</option>
                      </select>
                    </div>
                </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">date</label>
                        <div class="layui-input-inline">
                            <input type="date" name="update" autocomplete="off" class="layui-input">
                        </div>
                    </div>
               
                    <div class="layui-inline">
                        <button type="submit" class="layui-btn layui-btn-primary"  lay-submit lay-filter="submit"><i class="layui-icon"></i> Search</button>
                    </div>
                    
                </div>
            </form>
        </div>
    </fieldset>
    <div id="dele">
      <button id="b_st" onclick="de_file()">dele</button>
      </div>
    <div class="a2" id="a12" >
      <table cellpadding="5" rules=none width="80%" align="center" border="1"  id="text" style='margin-left:50%!important;transform:translateX(-50%);font-size: 16px;' >
      </table>
      </div>
 
     


</body>
<script>
    layui.use(['upload','table','form','layer'],function(){
    let upload = layui.upload;
    let table = layui.table;
    let form  = layui.form;
    let layer = layui.layer;
    form.on('select',function(data){
      //console.log(data);
       tpr = data.value;
      if(tpr=='bk'||tpr=='undefined'||tpr=='null'){
        layer.msg('please choose tpr before uploading or searching');
      }
    })
    
    var demoListView = $('#demoList')
  ,uploadListIns = upload.render({
    elem: '#testList'
    ,url: './5cupload.php' //改成您自己的上传接口
    ,accept: 'file'
    ,multiple: true //是否允许多文件上传
    ,auto: false //是否允许自动上传，否需要配置bindaction参数指定上传按钮来触发上传
    ,bindAction: '#testListAction' //上传按钮 触发
    ,before:function(obj){
   
      //console.log(tpr);
      this.data = {'tpr':tpr};
      
    },
    choose: function(obj){   //选择文件后的回调 
        console.log(obj); 
      var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
      //读取本地文件
      obj.preview(function(index, file, result){
          console.log(file);
        var tr = $(['<tr id="upload-'+ index +'">'
          ,'<td>'+ file.name +'</td>'
          ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
          ,'<td>等待上传[wait for uploading]</td>'
          ,'<td>'
            ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传[re-upload]</button>'
            ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除[delete]</button>'
          ,'</td>'
        ,'</tr>'].join(''));
        
        //单个重传
        tr.find('.demo-reload').on('click', function(){
          obj.upload(index, file);
        });
        
        //删除
        tr.find('.demo-delete').on('click', function(){
          delete files[index]; //删除对应的文件
          tr.remove();
          uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
        });
        
        demoListView.append(tr);
      });
    }
    ,done: function(res, index, upload){ 
        console.log(res);
        console.log(index);
        console.log(upload);
         //上传按钮后的回调
      if(res.code==0){ //上传成功
        var tr = demoListView.find('tr#upload-'+ index)
        ,tds = tr.children();
        tds.eq(2).html('<span style="color: #5FB878;">上传成功[upload success]</span>');
        tds.eq(3).html(''); //清空操作
        return delete this.files[index]; //删除文件队列已经上传成功的文件
      }
      this.error(index, upload);
    }
    ,error: function(index, upload){  //执行上传后的回调
        console.log(index);
        console.log(upload);
      var tr = demoListView.find('tr#upload-'+ index)
      ,tds = tr.children();
      tds.eq(2).html('<span style="color: #FF5722;">上传失败[upload fail]</span>');
      tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
    }
  });

  //form submit事件
    form.on('submit(submit)',function(data){
      let field  = data.field;
      let flag = '';
      //console.log(field);
      if(field.tpr=='bk'){
        layer.msg('please choose tpr before searching!',{time:1400});
        return false;
      }
      if(field.update==''){
       
         flag='all';

      }else{
         flag = 'notall';
      }
      let arr = [];
      arr[0] = flag;
      arr[1] = new Date(field.update).format('Ymd');
      arr[2] = field.tpr;
      $.ajax({
        url:'./5csearch.php',
        type:'post',
        data:{data:arr},
        dataType:'json',
        success:function(msg){
        console.log(msg);
        var div_re=document.getElementById('a12');
	 			document.getElementById('b_st').style.display="block";
					if(Array.isArray(msg)!=false){
		 				div_re.style.display="block";
	 					data=msg;
						ff=data[0];
			if(ff==1){ //
						//var a_id=data[1];
						//a_id=tpr;
						data.splice(0,1);
					if(data.length==0){
			 			var div_re=document.getElementById('a12');
		 				div_re.style.display="block";
						var tb_re=document.getElementById('text');
					$('#text').empty();
						tb_re.style.backgroundColor="Red";
						var tr=document.createElement("tr");
						var td=document.createElement("td");
						td.innerHTML="can't find file";
						tb_re.appendChild(tr);
						tr.appendChild(td);
						}else if(data.length>0&&data.length<5){
							var tb_re=document.getElementById('text');
					$('#text').empty();
						tb_re.style.backgroundColor="#96b97d";
						var tr=document.createElement("tr");
					for(var i=0;i<data.length;i++){
						var td=document.createElement("td");
						var a=document.createElement("a");
						var ck_box=document.createElement("input");
						a.href="javascript:void(0)";
            a.id=""+""+data[i]+"-"+""+i+"";
            a.name = field.tpr;
						a.setAttribute("onclick","report_data(this)");
						a.innerHTML=""+data[i]+"";
			
						ck_box.type="checkbox";
						ck_box.name="ck_dele";
						ck_box.class=field.tpr;
						ck_box.style.float="left";
						ck_box.style.display="none";
						ck_box.value=""+data[i]+"";
					
						td.appendChild(ck_box);
			
						tr.appendChild(td);
						td.appendChild(a);
						}
				tb_re.appendChild(tr);
				}else{
			
				var rs_row=parseInt(data.length/5);
				var rs_col=data.length%5;
				var tb_re=document.getElementById('text');
			$('#text').empty();
				tb_re.style.backgroundColor="#96b97d";
				var j=0;
		for(var i=0;i<rs_row;i++){
			var tr=document.createElement("tr");
			for(var x=0;x<5;x++){
				var td=document.createElement("td");
				var a=document.createElement("a");
				var ck_box=document.createElement("input");
				a.href="javascript:void(0)";
				
        a.id=""+""+data[i]+"-"+""+j+"";
        a.name = field.tpr;
				a.setAttribute("onclick","report_data(this)");
				a.innerHTML=""+data[j]+"";
				a.title="";
				ck_box.type="checkbox";
				ck_box.name="ck_dele";
				ck_box.value=""+data[j]+"";
        ck_box.class=field.tpr;
				ck_box.style.float="left";
				ck_box.style.display="none";
				td.appendChild(ck_box);
				
				tr.appendChild(td);
				td.appendChild(a);
				j++;
			}
		
		tb_re.appendChild(tr);
		}
		var tr=document.createElement("tr");
		for(var t=data.length-rs_col;t<data.length;t++){
			var td=document.createElement("td");
			var a=document.createElement("a");
			var ck_box=document.createElement("input");
			a.href="javascript:void(0)";
      a.id=""+""+data[i]+"-"+""+t+"";
      a.name = field.tpr;
			a.setAttribute("onclick","report_data(this)");
			a.innerHTML=""+data[t]+"";
			a.title="";
			
			ck_box.type="checkbox";
			ck_box.name="ck_dele";
			ck_box.class=field.tpr;
			ck_box.value=""+data[t]+"";
			ck_box.style.float="left";
			ck_box.style.display="none";
			td.appendChild(ck_box);
			
			tr.appendChild(td);
			td.appendChild(a);
		}
		tb_re.appendChild(tr);
			}
	}
	else{
    msg = data;
    if(msg!=""&&msg!=null&&msg.leng!=0){
			
      var d_brra=[];
      var d_brrb=[];
      d_brra=msg.slice(0,msg.length/2);
      d_brrb=msg.slice(msg.length/2);
        var tb_re=document.getElementById('text');
        $('#text').empty();
        tb_re.style.backgroundColor="#96b97d";
        for(var i=0;i<msg.length/2;i++){
          var tr=document.createElement("tr");
          var td=document.createElement("td");
          var a=document.createElement("a");
          var ck_box=document.createElement("input");
        a.href=""+d_brrb[i]+"";
        a.download=""+d_brra[i]+"";
        a.innerHTML=""+d_brra[i]+"";
        ck_box.type="checkbox";
        ck_box.name="ck_dele";
      //	ck_box.class=d_tpr;
        ck_box.value=""+d_brrb[i]+"";
        ck_box.style.float="left";
        ck_box.style.display="none";
        td.appendChild(ck_box);
        tb_re.appendChild(tr);
        tr.appendChild(td);
        td.appendChild(a);
        
        }	
   }else{
    
     var div_re=document.getElementById('a12');
     div_re.style.display="block";
      var tb_re=document.getElementById('text');
      $('#text').empty();
      tb_re.style.backgroundColor="Red";
      var tr=document.createElement("tr");
      var td=document.createElement("td");
      td.innerHTML="not data";
      tb_re.appendChild(tr);
      tr.appendChild(td);
   }
		
	}
	

	}

    
  },
        error:function(emsg){
          console.log(emsg);
         
        }

      })
    // console.log(field.update);
     return false;
    })


    })
     //多文件列表示例
function report_data(obj){
  console.log(obj);
	var folder=obj.innerText;
  var flag="notall";
  var tpr = obj.name;
  //var d_tpr=obj.id.split("-")[0];
  let arr= [];
  arr[0] = flag;
  arr[1] = folder;
  arr[1] = folder;
  arr[2] = tpr;
  

	
	$.ajax({
		type:"post",
	dataType:"json",
	url:"./5csearch.php",
	data:{data:arr},
	success:function(msg){
		 console.log(msg);//click week  、、上传文件list
		 if(msg!=""&&msg!=null&&msg.leng!=0){
			
				var d_brra=[];
				var d_brrb=[];
				d_brra=msg.slice(0,msg.length/2);
				d_brrb=msg.slice(msg.length/2);
					var tb_re=document.getElementById('text');
					$('#text').empty();
					tb_re.style.backgroundColor="#96b97d";
					for(var i=0;i<msg.length/2;i++){
						var tr=document.createElement("tr");
						var td=document.createElement("td");
						var a=document.createElement("a");
						var ck_box=document.createElement("input");
					a.href=""+d_brrb[i]+"";
					a.download=""+d_brra[i]+"";
					a.innerHTML=""+d_brra[i]+"";
					ck_box.type="checkbox";
					ck_box.name="ck_dele";
				//	ck_box.class=d_tpr;
					ck_box.value=""+d_brrb[i]+"";
					ck_box.style.float="left";
					ck_box.style.display="none";
					td.appendChild(ck_box);
					tb_re.appendChild(tr);
					tr.appendChild(td);
					td.appendChild(a);
					
					}	
		 }else{
			
			 var div_re=document.getElementById('a12');
			 div_re.style.display="block";
        var tb_re=document.getElementById('text');
        $('#text').empty();
        tb_re.style.backgroundColor="Red";
        var tr=document.createElement("tr");
        var td=document.createElement("td");
        td.innerHTML="not data";
        tb_re.appendChild(tr);
        tr.appendChild(td);
		 }
	},
	error:function(msg){
		 console.log(msg);
	}
	})
	
}

function de_file(){
	var box_arr=document.getElementsByName('ck_dele');
	if(box_arr[0].style.display=='none'){
		for(var i=0;i<box_arr.length;i++){
			box_arr[i].style.display='block';
		}
	}else if(box_arr[0].style.display=='block'){
		var checkdata="";
		for(var i=0;i<box_arr.length;i++){
			if(box_arr[i].checked){
				checkdata+=box_arr[i].value+",";
			}
		}
		if(checkdata==""||checkdata==null||checkdata==undefined){
			for(var i=0;i<box_arr.length;i++){
				box_arr[i].style.display='none';
			}
		}else{
			var d=confirm('delete file ?');
			if(d==true){
			
				delete_file(checkdata,box_arr[0].class);
			
			//window.location.reload();
				
			}else{
				for(var i=0;i<box_arr.length;i++){
					box_arr[i].checked="";
				}
			}
		}
		
	}
	
}
function delete_file(paths,tpr){
  //console.log(paths);
  //console.log(tpr);
	$.ajax({
	type:'post',
	dataType:'json',
	url:'5cdelete.php',
	data:{paths:paths,tpr:tpr},
	success:function(msg){
		console.log(msg);
		if(msg==0){
			alert("delete error");
			return;
		}else{
      alert("delete success");
      window.location.reload();
		}
	}
	})
	
}
    

  
</script>
</html>